unit DetalleControlActividades;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs,
  FMX.Controls.Presentation, FMX.StdCtrls, FMX.Layouts, FMX.ScrollBox, FMX.Memo;

type
  TForm4 = class(TForm)
    ScaledLayout1: TScaledLayout;
    DescripcionExtra: TLabel;
    ToolBar1: TToolBar;
    Iniciar: TSpeedButton;
    Pendiente: TSpeedButton;
    Finalizar: TSpeedButton;
    Cerrar: TSpeedButton;
    Home: TSpeedButton;
    Memo1: TMemo;
    procedure HomeClick(Sender: TObject);
    procedure IniciarClick(Sender: TObject);
    procedure PendienteClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form4: TForm4;

implementation
Uses Principal,ControlActividades,Datas;
{$R *.fmx}

procedure TForm4.HomeClick(Sender: TObject);
begin
  Application.Terminate;
   Exit;
end;

procedure TForm4.IniciarClick(Sender: TObject);
var
  nuevo_id : integer;
  estat : string;
begin
    Iniciar.Enabled:=False;
    Pendiente.Enabled:=True;
    Finalizar.Enabled:=True;

    try
       Datas.DataModule1.Consulta.SQL.Clear;
       Datas.DataModule1.Consulta.SQL.Add('select ID,ESTATUS AS ESTA from actividad_taller where orden=:id and agente=:agente and tarea=:tarea and estatus in (:estatus,:estatus1)');
       Datas.DataModule1.Consulta.ParamByName('id').AsInteger:=StrToInt(Form3.IDSOrdenes.Lines.Strings[Form3.Ordenes.ItemIndex]);
       Datas.DataModule1.Consulta.ParamByName('estatus').AsString:='PENDIENTE';
       Datas.DataModule1.Consulta.ParamByName('estatus1').AsString:='NO INICIADA';
       Datas.DataModule1.Consulta.ParamByName('agente').AsString:=Principal.Form2.ListadoUsuarios.Items[Principal.Form2.ListadoUsuarios.ItemIndex].Text;
       Datas.DataModule1.Consulta.ParamByName('tarea').AsString:=DescripcionExtra.Text;
       Datas.DataModule1.Consulta.ExecSQL;

       if Datas.DataModule1.Consulta.RecordCount > 0 then
       begin

        estat := Datas.DataModule1.Consulta.FieldByName('ESTA').AsString;
        nuevo_id := Datas.DataModule1.Consulta.FieldByName('ID').AsInteger;
        if (estat = 'PENDIENTE') OR (estat = 'NO INICIADA')  then
        begin
                  Datas.DataModule1.Consulta.SQL.Clear;
                  Datas.DataModule1.Consulta.SQL.Add('update actividad_taller set fecha_inicio=getdate(),estatus=:estat where ID=:orden and agente=:agente and estatus=:estatus');
                  Datas.DataModule1.Consulta.ParamByName('estat').AsString:='TRABAJANDO';
                  Datas.DataModule1.Consulta.ParamByName('orden').AsInteger:=nuevo_id;
                  Datas.DataModule1.Consulta.ParamByName('estatus').AsString:=estat;
                  Datas.DataModule1.Consulta.ParamByName('agente').AsString:=Principal.Form2.ListadoUsuarios.Items[Principal.Form2.ListadoUsuarios.ItemIndex].Text;;
                  Datas.DataModule1.Consulta.ExecSQL;
        end;
       end
       else
       begin
          Datas.DataModule1.Consulta.SQL.Clear;
          Datas.DataModule1.Consulta.SQL.Add('insert into actividad_taller(orden,agente,tarea,fecha_inicio,estatus) values (:orden,:agente,:tarea,getdate(),:estatus)');
          Datas.DataModule1.Consulta.ParamByName('orden').AsInteger:=StrToInt(Form3.IDSOrdenes.Lines.Strings[Form3.Ordenes.ItemIndex]);
          Datas.DataModule1.Consulta.ParamByName('agente').AsString:=Principal.Form2.ListadoUsuarios.Items[Principal.Form2.ListadoUsuarios.ItemIndex].Text;
          Datas.DataModule1.Consulta.ParamByName('tarea').AsString:=DescripcionExtra.Text;
          Datas.DataModule1.Consulta.ParamByName('estatus').AsString:='TRABAJANDO';
          Datas.DataModule1.Consulta.ExecSQL;
          showmessage('no hay registros');
       end;
    finally

    end;
end;

procedure TForm4.PendienteClick(Sender: TObject);
begin
    if (memo1.Visible = True) and (Memo1.Text.Length < 10) then
    begin
      ShowMessage('Debe ingresar una justificacion mayor a 10 caracteres');
    end;
end;

end.
